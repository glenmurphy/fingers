<body></body>
<script type="text/javascript">
var myCharacteristic;
var socket;

function setStatus(text) {
  document.getElementById('status').innerHTML = text;
}

function connect() {
  setStatus("connecting");
  socket = new WebSocket('ws://localhost:18000');
  socket.addEventListener('open', function (event) {
    setStatus("connected");
  });
  socket.addEventListener('close', function (event) {
    connect();
  });
}

function start() {
  // id:              fb:fe:ab:25:e4:3b
  // service:         39de08dc-624e-4d6f-8e42-e1adb7d92fe1
  // characteristic:  53b2ad55-c810-4c75-8a25-e1883a081ef6

  let serviceUuid = "39de08dc-624e-4d6f-8e42-e1adb7d92fe1";
  let characteristicUuid = "53b2ad55-c810-4c75-8a25-e1883a081ef6"

  setStatus('Requesting Bluetooth Device...');
  navigator.bluetooth.requestDevice({filters: [{services: [serviceUuid]}]})
  .then(device => {
    setStatus('Connecting to GATT Server...');
    return device.gatt.connect();
  })
  .then(server => {
    setStatus('Getting Service...');
    return server.getPrimaryService(serviceUuid);
  })
  .then(service => {
    setStatus('Getting Characteristic...');
    return service.getCharacteristic(characteristicUuid);
  })
  .then(characteristic => {
    myCharacteristic = characteristic;
    return myCharacteristic.startNotifications().then(_ => {
      setStatus('Notifications started');
      myCharacteristic.addEventListener('characteristicvaluechanged',
          handleNotifications);
    });
  })
  .catch(error => {
    setStatus('Error: ' + error);
  });
}

function onStopButtonClick() {
  if (myCharacteristic) {
    myCharacteristic.stopNotifications()
    .then(_ => {
      setStatus('Notifications stopped');
      myCharacteristic.removeEventListener('characteristicvaluechanged',
          handleNotifications);
    })
    .catch(error => {
      setStatus('Argh! ' + error);
    });
  }
}

var buttons = [
  { 
    name : "center",
    mask : 1,
    down : false
  },
  { 
    name : "up",
    mask : 2,
    down : false
  },
  { 
    name : "down",
    mask : 4,
    down : false
  },
  { 
    name : "fwd",
    mask : 8,
    down : false
  },
  { 
    name : "back",
    mask : 16,
    down : false
  },
]

function handleNotifications(event) {
  var val = event.target.getUint8(4);

  for (var i = 0; i < buttons.length; i++) {
    var button = buttons[i];
    var down = (val & button.mask);
    if (down && !button.down) {
      socket.send(button.name);
      setStatus("Button: " + button.name);
    }
    button.down = down;
  }
}
</script>
<style type="text/css">
body {
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.button {
  width:200px;
  height:42px;
  display: inline-flex;
  align-items: center;
  font-size:16px;
  justify-content: space-around;
  background-color:#36f;
  color:white;
}
#status {
  margin-top:14px;
  font-size:12px;
  display:block;
  width:200px;
  text-align:center;
}
</style>
<title>Fingers Bluetooth</title>
<body>
<div>
  <div class="button" onclick="connect(); start(); return false;">Start</div>
</div>
<div id="status">...</div>
</body>